<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Used Car Price Predictor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .predict-button {
            transition: all 0.2s;
            background-image: linear-gradient(to right, #10b981, #059669);
        }
        .predict-button:hover {
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
            transform: translateY(-1px);
        }
        /* Custom scrollbar for better appearance on overflow */
        .form-container::-webkit-scrollbar {
            width: 8px;
        }
        .form-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
        }
        /* Style for the 'What If?' slider */
        #km_driven_slider::-webkit-slider-thumb {
            background-color: #ec4899; /* Pink */
        }
        #km_driven_slider::-moz-range-thumb {
            background-color: #ec4899; /* Pink */
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-5xl lg:flex lg:space-x-8">

        <!-- Left Column: Input Form -->
        <div class="lg:w-3/5 w-full bg-white card rounded-xl p-6 sm:p-8 mb-6 lg:mb-0">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Car Price Estimator</h1>
            <p class="text-gray-500 mb-6">Enter your vehicle's details below to get an instant valuation.</p>
            
            <form id="prediction-form" class="space-y-6">
                
                <!-- Row 1: Brand & Model (MOCKED DATA) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="brand" class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                        <select id="brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <!-- MOCK DATA: Replace with unique brands from cardekho_dataset -->
                            <option value="Maruti">Maruti</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Honda">Honda</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Mahindra">Mahindra</option>
                            <option value="Tata">Tata</option>
                        </select>
                    </div>
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 mb-1">Model (Base)</label>
                        <input type="text" id="model" value="Swift" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., Swift, Vento">
                    </div>
                </div>

                <!-- Row 2: Age & Seats -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Manufacturing Year</label>
                        <input type="number" id="year" value="2018" min="1990" max="2024" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 2018">
                        <p id="vehicle-age-display" class="mt-1 text-xs text-gray-500">Vehicle Age: 6 years</p>
                    </div>
                    <div>
                        <label for="seats" class="block text-sm font-medium text-gray-700 mb-1">Seats</label>
                        <input type="number" id="seats" value="5" min="2" max="10" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 5">
                    </div>
                </div>

                <!-- Row 3: KM Driven INPUT FIELD -->
                <div>
                    <label for="km_driven_input" class="block text-sm font-medium text-gray-700 mb-1">KM Driven (km)</label>
                    <input type="number" id="km_driven_input" value="50000" min="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 50000">
                </div>

                <!-- Row 4: Engine Specs -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                        <label for="mileage" class="block text-sm font-medium text-gray-700 mb-1">Mileage (kmpl)</label>
                        <input type="number" id="mileage" value="20.5" step="0.1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 20.5">
                    </div>
                    <div>
                        <label for="engine" class="block text-sm font-medium text-gray-700 mb-1">Engine (CC)</label>
                        <input type="number" id="engine" value="1197" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 1197">
                    </div>
                    <div>
                        <label for="max_power" class="block text-sm font-medium text-gray-700 mb-1">Max Power (bhp)</label>
                        <input type="number" id="max_power" value="82" step="0.1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g., 82">
                    </div>
                </div>

                <!-- Row 5: Categorical Features -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                        <label for="fuel_type" class="block text-sm font-medium text-gray-700 mb-1">Fuel Type</label>
                        <select id="fuel_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="CNG">CNG</option>
                            <option value="LPG">LPG</option>
                        </select>
                    </div>
                    <div>
                        <label for="transmission_type" class="block text-sm font-medium text-gray-700 mb-1">Transmission</label>
                        <select id="transmission_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Manual">Manual</option>
                            <option value="Automatic">Automatic</option>
                        </select>
                    </div>
                    <div>
                        <label for="seller_type" class="block text-sm font-medium text-gray-700 mb-1">Seller Type</label>
                        <select id="seller_type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Individual">Individual</option>
                            <option value="Dealer">Dealer</option>
                        </select>
                    </div>
                </div>
            </form>

            <button onclick="handlePrediction(false)" class="predict-button w-full mt-8 py-3 text-white font-semibold text-lg rounded-lg hover:shadow-lg">
                Get Price Prediction
            </button>
            <div id="loading-indicator" class="hidden mt-4 text-center text-emerald-600 font-medium">Calculating...</div>
        </div>

        <!-- Right Column: Prediction Output -->
        <div class="lg:w-2/5 w-full bg-white card rounded-xl p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Prediction Summary</h2>
            
            <div class="text-center py-10 bg-emerald-50 rounded-lg border-2 border-dashed border-emerald-300 mb-8">
                <p class="text-gray-500 text-lg mb-2">Estimated Selling Price</p>
                <p id="predicted-price" class="text-5xl font-extrabold text-emerald-700">â‚¹ ???</p>
            </div>

            <!-- Contextual Feedback -->
            <div id="feedback-section" class="space-y-4">
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Prediction Confidence (MOCK)</p>
                        <p id="confidence-range" class="text-sm text-gray-600">Model not yet run. Click 'Get Price Prediction' to see the range.</p>
                    </div>
                </div>
                
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.536 12.536a7 7 0 010-9.072M14.464 12.536a7 7 0 000-9.072" />
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Current Market Check</p>
                        <p id="market-feedback" class="text-sm text-gray-600">The predicted price reflects current market conditions for similar models.</p>
                    </div>
                </div>
            </div>

            <!-- New Post-Prediction KM Slider Section (Hidden by default) -->
            <div id="km-adjuster-section" class="hidden mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    What If? <span class="ml-2 text-sm font-normal text-gray-500">(Adjust KM Driven)</span>
                </h3>
                
                <label for="km_driven_slider" class="block text-sm font-medium text-gray-700 mb-1">
                    Adjusted KM: <span id="km_adjust_value" class="font-bold text-pink-600">50,000</span> km
                </label>
                <!-- Instruction showing the dynamic range -->
                <p id="km-range-instruction" class="text-xs text-gray-500 mb-2">Range: +/- 100 km from original entry.</p> 

                <!-- The slider: attributes will be set dynamically in JS -->
                <input type="range" id="km_driven_slider" value="50000" class="w-full h-2 bg-pink-200 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-pink-600">
            </div>

        </div>
    </div>

    <script>
        const CURRENT_YEAR = new Date().getFullYear();
        
        // --- Element References ---
        const priceOutput = document.getElementById('predicted-price');
        const kmInput = document.getElementById('km_driven_input'); // Main KM number input
        const yearInput = document.getElementById('year');
        const ageDisplay = document.getElementById('vehicle-age-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const confidenceRange = document.getElementById('confidence-range');
        const kmAdjusterSection = document.getElementById('km-adjuster-section'); // Slider section container
        const kmAdjustSlider = document.getElementById('km_driven_slider'); // The slider element
        const kmAdjustValueDisplay = document.getElementById('km_adjust_value'); // Slider value display
        const kmRangeInstruction = document.getElementById('km-range-instruction');
        
        // Global variable to store features from the last successful button click
        let lastSuccessfulFeatures = null;


        // --- Utility Functions ---

        /** Formats a number to Indian Rupee currency string. */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(amount);
        };

        /** Calculates age from year and updates the display. */
        const updateVehicleAge = () => {
            const year = parseInt(yearInput.value);
            if (year > 0 && year <= CURRENT_YEAR) {
                const age = CURRENT_YEAR - year;
                ageDisplay.textContent = `Vehicle Age: ${age} years`;
            } else {
                 ageDisplay.textContent = `Vehicle Age: Invalid Year`;
            }
        };
        
        /** Collects all form data into an object. */
        function collectAllFormData() {
            return {
                brand: document.getElementById('brand').value,
                model: document.getElementById('model').value,
                year: document.getElementById('year').value,
                seats: document.getElementById('seats').value,
                km_driven: parseInt(kmInput.value), // Read from number input
                mileage: document.getElementById('mileage').value,
                engine: document.getElementById('engine').value,
                max_power: document.getElementById('max_power').value,
                fuel_type: document.getElementById('fuel_type').value,
                transmission_type: document.getElementById('transmission_type').value,
                seller_type: document.getElementById('seller_type').value,
            };
        }

        /**
         * Standalone function for the MOCK prediction logic.
         * In the real app, this logic would be on the backend.
         */
        function calculateMockPrice(features) {
            const basePrice = 750000;
            const age = CURRENT_YEAR - parseInt(features.year);
            const kmFactor = features.km_driven / 100000;
            const depreciation = (basePrice * (age * 0.05)) + (basePrice * (kmFactor * 0.15));
            let predictedPrice = basePrice - depreciation;

            if (features.transmission_type === 'Automatic') predictedPrice *= 1.15;
            if (features.fuel_type === 'Diesel') predictedPrice *= 1.05;
            if (features.brand === 'Maruti') predictedPrice *= 0.9;
            
            predictedPrice = Math.max(50000, predictedPrice);
            
            return Math.round(predictedPrice / 1000) * 1000; // Round to nearest 1000
        }

        // --- Event Handlers ---

        // 1. Live Update from Post-Prediction Slider
        async function updatePredictionFromSlider() {
            if (!lastSuccessfulFeatures) return;

            const newKmValue = parseInt(kmAdjustSlider.value);
            // Update display value
            kmAdjustValueDisplay.textContent = new Intl.NumberFormat('en-IN').format(newKmValue);
            
            // Create the feature set for this prediction: use stored features, but swap km_driven
            const sliderFeatures = { ...lastSuccessfulFeatures, km_driven: newKmValue };
            
            // Run prediction immediately (short mock latency)
            const finalPrice = calculateMockPrice(sliderFeatures);
            
            await new Promise(r => setTimeout(r, 100)); // Simulate low latency

            // Update UI with MOCK confidence range
            const lowRange = Math.round(finalPrice * 0.94);
            const highRange = Math.round(finalPrice * 1.06);
            
            priceOutput.textContent = formatCurrency(finalPrice);
            confidenceRange.textContent = `90% of similar cars sell between ${formatCurrency(lowRange)} and ${formatCurrency(highRange)}.`;
        }

        kmAdjustSlider.addEventListener('input', updatePredictionFromSlider);

        // 2. Year Input Handler
        yearInput.addEventListener('input', updateVehicleAge);
        window.onload = updateVehicleAge; // Set initial age on load


        /**
         * Main function to handle prediction request.
         * @param {boolean} isSliderUpdate - True if triggered by slider for live update, false if button click.
         */
        async function handlePrediction(isSliderUpdate = false) {
            const form = document.getElementById('prediction-form');
            if (!isSliderUpdate && !form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const features = collectAllFormData();

            // Set loading state only for the initial button click
            if (!isSliderUpdate) {
                loadingIndicator.classList.remove('hidden');
                priceOutput.textContent = '...';
                kmAdjusterSection.classList.add('hidden'); // Hide adjuster on new full request
            }
            
            // --- MOCK PREDICTION LOGIC ---
            // In a real app, you would make an API call here.
            const finalPrice = calculateMockPrice(features);

            await new Promise(r => setTimeout(r, isSliderUpdate ? 100 : 750)); // Simulate API latency

            // --- UI Update & Feature Activation ---

            loadingIndicator.classList.add('hidden');
            
            // MOCK Confidence Range Calculation
            const lowRange = Math.round(finalPrice * 0.94);
            const highRange = Math.round(finalPrice * 1.06);

            priceOutput.textContent = formatCurrency(finalPrice);
            confidenceRange.textContent = `90% of similar cars sell between ${formatCurrency(lowRange)} and ${formatCurrency(highRange)}.`;
            
            // Market feedback
            if (finalPrice > 600000) {
                 document.getElementById('market-feedback').textContent = "This is a high-value model. Verify service history.";
            } else if (finalPrice < 200000) {
                 document.getElementById('market-feedback').textContent = "Economy model. Priced correctly for age and use.";
            } else {
                 document.getElementById('market-feedback').textContent = "The predicted price reflects current market conditions for similar models.";
            }

            // --- ACTIVATE SLIDER FOR "WHAT IF" SCENARIO AFTER INITIAL PREDICTION ---
            if (!isSliderUpdate) {
                // 1. Store the full feature set to be used by the slider
                lastSuccessfulFeatures = features;
                
                // 2. Unhide the slider section
                kmAdjusterSection.classList.remove('hidden');
                
                // --- Set the dynamic range for the slider ---
                const originalKm = features.km_driven;
                const minKm = Math.max(0, originalKm - 100); // Prevent negative KM
                const maxKm = originalKm + 100;
                
                kmAdjustSlider.min = minKm;
                kmAdjustSlider.max = maxKm;
                kmAdjustSlider.step = 1; // Allow 1km steps within the narrow range
                kmAdjustSlider.value = originalKm; // Set the starting position

                // 3. Initialize the slider display value and instruction text
                kmAdjustValueDisplay.textContent = new Intl.NumberFormat('en-IN').format(originalKm);
                kmRangeInstruction.textContent = `Range: ${new Intl.NumberFormat('en-IN').format(minKm)} km to ${new Intl.NumberFormat('en-IN').format(maxKm)} km`;
            }
        }
    </script>

</body>
</html>
